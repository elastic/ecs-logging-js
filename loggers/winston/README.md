<img align="right" width="auto" height="auto" src="https://www.elastic.co/static-res/images/elastic-logo-200.png">

# @elastic/ecs-winston-format

[![Build Status](https://apm-ci.elastic.co/buildStatus/icon?job=apm-agent-nodejs%2Fecs-logging-js-mbp%2Fmaster)](https://apm-ci.elastic.co/job/apm-agent-nodejs/job/ecs-logging-js-mbp/job/master/)  [![js-standard-style](https://img.shields.io/badge/code%20style-standard-brightgreen.svg?style=flat)](http://standardjs.com/)

A formatter for the [winston](https://www.npmjs.com/package/winston) logger compatible with [Elastic Common Schema](https://www.elastic.co/guide/en/ecs/current/index.html).<br/>
In combination with [filebeat](https://www.elastic.co/products/beats/filebeat) you can send your logs directly to Elasticsearch and leverage [Kibana's Logs UI](https://www.elastic.co/guide/en/infrastructure/guide/current/logs-ui-overview.html) to inspect all logs in one single place.

---

**Please note** that this library is in a **beta** version and backwards-incompatible changes might be introduced in future releases. While we strive to comply to [semver](https://semver.org/), we can not guarantee to avoid breaking changes in minor releases.

---

## Install
```sh
npm i @elastic/ecs-winston-format
```

## Usage
```js
const winston = require('winston')
const ecsFormat = require('@elastic/ecs-winston-format')

const logger = winston.createLogger({
  level: 'info',
  format: ecsFormat(),
  transports: [
    new winston.transports.Console()
  ]
})

logger.info('ecs is cool!')
logger.error('ecs is cool!', { hello: 'world' })
```

### Serialization

The log will be serialized automatically by the formatter, you don't need to add the [JSON](https://github.com/winstonjs/logform#json) formatter.

### Timestamp
The timestamp will automatically be generated by the formatter, you don't need to add the [timestamp](https://github.com/winstonjs/logform#timestamp) formatter.


### HTTP Request and Response Logging

With the `convertReqRes: true` option, the formatter will automatically
convert Node.js core [request](https://nodejs.org/api/http.html#http_class_http_incomingmessage)
and [response](https://nodejs.org/api/http.html#http_class_http_serverresponse)
objects when passed as the `req` and `res` meta fields, respectively.

```js
const http = require('http')
const winston = require('winston')
const ecsFormat = require('@elastic/ecs-winston-format')

const logger = winston.createLogger({
  level: 'info',
  format: ecsFormat({convertReqRes: true}),  // <-- use convertReqRes option
  transports:
    new winston.transports.Console()
  ]
})

const server = http.createServer(handler)
server.listen(3000, () => {
  logger.info('listening at http://localhost:3000')
})

function handler (req, res) {
  res.setHeader('Foo', 'Bar')
  res.end('ok')
  logger.info('handled request', { req, res })  // <-- pass in `req` and/or `res`
}
```

This will produce logs with request and response info using
[ECS HTTP fields](https://www.elastic.co/guide/en/ecs/current/ecs-http.html).
For example:

```sh
% node examples/http.js | jq .    # using jq for pretty printing
...                               # run 'curl http://localhost:3000/'
{
  "@timestamp": "2021-01-13T22:00:07.442Z",
  "log.level": "info",
  "message": "handled request",
  "ecs": {
    "version": "1.5.0"
  },
  "http": {
    "version": "1.1",
    "request": {
      "method": "get",
      "headers": {
        "host": "localhost:3000",
        "accept": "*/*"
      }
    },
    "response": {
      "status_code": 200,
      "headers": {
        "foo": "Bar"
      }
    }
  },
  "url": {
    "path": "/",
    "full": "http://localhost:3000/"
  },
  "user_agent": {
    "original": "curl/7.64.1"
  }
}
```


## License

This software is licensed under the [Apache 2 license](./LICENSE).
